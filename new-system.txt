#!/usr/bin/env bash
# vim: ft=sh
#
# Install according to
# - https://wiki.archlinux.org/index.php/Installation_guide
# - https://wiki.archlinux.org/index.php/Systemd-boot
# use
# > pacstrap /mnt base vim

set -euo pipefail

declare -A ccodes=()
ccodes[white]=$(tput setaf 7)
ccodes[cyan]=$(tput setaf 6)
ccodes[magenta]=$(tput setaf 5)
ccodes[blue]=$(tput setaf 4)
ccodes[yellow]=$(tput setaf 3)
ccodes[green]=$(tput setaf 2)
ccodes[red]=$(tput setaf 1)
ccodes[black]=$(tput setaf 0)
ccodes[reset]=$(tput sgr0)
ccodes[bold]=$(tput bold)

info() {
  echo "${ccodes[bold]}${ccodes[white]}$*${ccodes[reset]}"
}

declare -A conf=()
conf[locale]=en_US.UTF-8
conf[keymap]=de
conf[user]="${1:-}"

info "Checking locale"
if ! grep "^${conf[locale]} UTF-8" /etc/locale.gen >/dev/null; then
  info "Generating ${conf[locale]} locale"
  echo "${conf[locale]} UTF-8" >> /etc/locale.gen
  locale-gen
fi

localectl status | grep "System Locale: LANG=${conf[locale]}" > /dev/null || {
  info "Setting system locale to ${conf[locale]}"
  localectl set-locale "LANG=${conf[locale]}"
}

localectl status | grep "VC Keymap: ${conf[keymap]}" > /dev/null || {
  info "Setting keymap to ${conf[keymap]}"
  localectl set-keymap "${conf[keymap]}"
}

info "Enable NTP for system clock"
timedatectl set-ntp true

info "Adding convinience defauls to /etc/profile.d/sane-defauls.sh"
cat>/etc/profile.d/sane-defauls.sh <<EOF
alias ls='ls --color=auto --group-directories-first'
alias ll='ls -al'
alias less='less -S'
alias v='vim'
alias vim='vim'
alias ..='cd ..'

export EDITOR=vim
EOF

info "Disable anoying speeper beep as termbell (blacklist module pcspkr)"
echo "blacklist pcspkr" > /etc/modprobe.d/nobeep.conf

info "Updating pacman databases"
pacman -Sy --noconfirm

pacman -Q reflector &> /dev/null || {
  info "Installing reflector to update pacmans mirrorlist"
  pacman -S --noconfirm reflector
}
info "Updating pacmans mirrorlist"
reflector --verbose -c Germany -p https --age 12 --sort score -f 5 --save /etc/pacman.d/mirrorlist

declare -a installPkgs=()
declare -a enableUnits=(gdm NetworkManager)
# This are the gnome packages from pacmans 'gnome'-group I want.
# Use pacman -Sgg gnome to see all the packages of group 'gnome'.
installPkgs+=(adwaita-icon-theme eog evince gdm gnome-backgrounds gnome-calculator gnome-control-center gnome-dictionary gnome-disk-utility gnome-font-viewer gnome-keyring gnome-screenshot gnome-session gnome-settings-daemon gnome-shell gnome-shell-extensions gnome-system-monitor gnome-terminal gnome-themes-standard gucharmap gvfs gvfs-mtp gvfs-smb mousetweaks mutter nautilus networkmanager tracker tracker-miners xdg-user-dirs-gtk)

# install some additional packages
installPkgs+=(sudo gnome-tweak-tool openssh zsh)

# info "Checking for video drivers"
# xf86driver=""
# # Intel VGA, add nvidia and ati at some point
# if vgahw=$(lspci -d 8086::0300) > /dev/null; then
#   pkgs+=(xf86-video-intel)
#   info " => found Intel graphics card, will install $xf86driver"
#   echo " => $vgahw"
# fi

# check if running on laptop, if so install tlp
if hostnamectl | grep "Chassis: lapop"; then
  info "Detected a laptop, will install TLP"
  installPkgs+=(tlp)
  enableUnits+=(tlp)
fi

info "Installing packages"
pacman -S --needed --noconfirm ${installPkgs[@]}

for unit in "${enableUnits[@]}"; do
  info "Enabling systemd unit $unit"
  systemctl enable "$unit"
done

info "Adding rule to sudoers.d to allow sudo access for users of group 'wheel'"
echo '%wheel ALL=(ALL) ALL' > /etc/sudoers.d/allow-wheel
echo 'Defaults passwd_timeout=0' > /etc/sudoers.d/timeout
chmod 0440 /etc/sudoers.d/*
info "Checking sudo conf"
visudo -c -s

if [[ -n ${conf[user]} ]] && ! getent passwd "${conf[user]}" >/dev/null; then
  info "Adding user ${conf[user]}"
  useradd -m -G users,wheel -s /usr/bin/zsh "${conf[user]}"
  passwd "${conf[user]}"
fi

